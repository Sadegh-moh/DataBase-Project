{
  "size": 0,
  "timeout": "60s",
  "runtime_mappings": {
    "bucket20": {
      "type": "long",
      "script": { "source": "int h=0; if (doc['userId'].size()!=0) h=doc['userId'].value.hashCode(); else if (doc['productId'].size()!=0) h=doc['productId'].value.hashCode(); emit(Math.floorMod(h,5));" }
    }
  },
  "query": {
    "bool": {
      "filter": [
        { "term": { "score": 1.0 } },
        { "term": { "bucket20": 0 } }
      ]
    }
  },
  "aggs": {
    "sample": {
      "sampler": { "shard_size": 400 },
      "aggs": {
        "top_terms": {
          "terms": {
            "field": "text.tokens",
            "size": 10,
            "shard_size": 150,
            "min_doc_count": 50,
            "exclude": "^(i|you|we|they|have|has|had|all|one|just|also|really|very|music|album|cd|song|songs)$"
          }
        }
      }
    }
  }
}
